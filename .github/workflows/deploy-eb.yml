name: Deploy to Elastic Beanstalk

on:
  push:
    branches: [ "main" ]
    ## 노트북/문서/README만 바뀌면 트리거 자체를 막기
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - 'notebooks/**'
      - '**/*.ipynb'
      - 'source_documents/**'
  workflow_dispatch:

# 브랜치별 단일 실행 보장
concurrency:
  group: eb-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    ## 커밋 메시지에 [skip deploy]가 있으면 전체 스킵
    if: ${{ !contains(github.event.head_commit.message, '[skip deploy]') }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      ## 변경 감지 (배포에 영향 있는 파일들만)
      - name: Detect deploy-relevant changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            deploy:
              - 'Dockerfile'
              - 'Procfile'
              - 'Dockerrun.aws.json'
              - '.platform/**'
              - '.ebextensions/**'
              - '.elasticbeanstalk/**'
              - 'requirements.txt'
              - 'chat.py'
              - 'llm.py'
              - 'config.py'
              - 'app/**'
              - '.github/workflows/deploy-eb.yml'

      - name: Skip deploy if no relevant changes
        if: steps.changes.outputs.deploy != 'true'
        run: echo "No deploy-relevant changes. Skipping Elastic Beanstalk deployment."

      ## ❗ 가장 안전한 패키징: git에 추적되는 파일만 번들
      - name: Create application bundle (zip)
        if: steps.changes.outputs.deploy == 'true'
        run: |
          git archive -o app.zip HEAD

        ## 만약 zip -r을 계속 쓰고 싶다면 아래처럼 제외 목록을 넓히세요.
        ## zip -r app.zip . \
        ##   -x ".git/*" ".github/*" ".vscode/*" "__pycache__/*" "*.pyc" \
        ##      "notebooks/*" "source_documents/*" ".elasticbeanstalk/logs/*" ".env"

      - name: Deploy to Elastic Beanstalk
        if: steps.changes.outputs.deploy == 'true'
        uses: einaregilsson/beanstalk-deploy@v21
        with:
          aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          application_name: chatbot-law
          environment_name: chatbot-law-env
          region: ap-northeast-2
          version_label: ${{ github.run_id }}-${{ github.run_attempt }}
          deployment_package: app.zip
